<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEA Substation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            background: #16213e;
        }
        
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        .login-container {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .pin-input {
            padding: 10px;
            width: 100%;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            background: #333;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 5px;
        }
        
        .pin-input::placeholder {
            color: #aaa;
        }
        
        .login-btn {
            padding: 10px;
            width: 100%;
            background: #e94560;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #d1344e;
        }
        
        #dashboard {
            display: none;
        }
        
        .header {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #333;
        }
        
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 15px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            width: 260px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .status-box {
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            text-align: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .on {
            background: green;
        }
        
        .off {
            background: red;
        }
        
        @keyframes blink-red-animation {
            0%, 100% {
                background-color: red;
                color: white;
                transform: scale(1);
            }
            50% {
                background-color: darkred;
                color: white;
                transform: scale(1.05);
            }
        }
        
        .blink-red {
            animation: blink-red-animation 1s infinite;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .visitor-counter {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
        }
        
        .counter-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e94560;
        }
        
        button {
            cursor: pointer;
            padding: 8px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            background: #0f3460;
            color: white;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1a4a7a;
        }
        
        .notification-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .toggle-label {
            margin-left: 8px;
            font-size: 0.9rem;
        }
        
        /* Events Tab */
        #events-tab {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            overflow: auto;
            color: white;
            z-index: 1000;
            padding: 20px;
        }
        
        #events-tab table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        #events-tab th, #events-tab td {
            border: 1px solid #fff;
            padding: 10px;
            text-align: center;
        }
        
        #events-tab th {
            background: #444;
        }
        
        #close-events-btn {
            background: #e94560;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        #close-events-btn:hover {
            background: #d1344e;
        }
        
        .events-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }
        
        .no-events {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .events-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .last-update {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .update-events-btn {
            background: #4CAF50;
            margin-left: 10px;
        }
        
        .update-events-btn:hover {
            background: #45a049;
        }
        
        .update-events-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        /* Notification styles */
        .notification-permission {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .notification-permission button {
            background: #e94560;
            margin-left: 10px;
        }
        
        .notification-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .status-online {
            color: #4CAF50;
        }
        
        .status-offline {
            color: #e94560;
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-container">
            <h1>âš¡ NEA Substation</h1>
            <p>Enter PIN (****)</p>
            <input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="Enter PIN">
            <button id="login-btn" class="login-btn">Login</button>
            <div class="notification-permission" id="notification-permission-prompt">
                <p>Enable browser notifications for status alerts?</p>
                <button id="enable-notifications">Enable</button>
            </div>
            <div class="notification-status" id="notification-status">
                Notifications: <span id="notification-status-text" class="status-offline">Disabled</span>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="header">
            <h1>âš¡ 132/33/11KV SUNWAL SUBSTATION</h1>
            <p>Current Time: <span id="current-time">--:--</span> | Last Update: <span id="last-ref-time">--:--</span></p>
            <button id="refresh-btn">ðŸ”„ Refresh</button>
            <button id="logout-btn">ðŸšª Logout</button>
            <button id="events-btn">ðŸ“œ Events</button>
            <div class="notification-toggle">
                <input type="checkbox" id="notification-toggle" checked>
                <label for="notification-toggle" class="toggle-label">Enable Notifications</label>
            </div>
            <div class="notification-status">
                Background Monitoring: <span id="background-status" class="status-online">Active</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>132 kV System</h2>
                <div id="33kv-system" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV INCOMER</h2>
                <div id="Feeder-1" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV ASHNIYA-1</h2>
                <div id="Feeder-2" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV RAMAWAPUR-2</h2>
                <div id="Feeder-3" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>SPARE FEEDER-3</h2>
                <div id="Feeder-4" class="status-box">--</div>
            </div>
        </div>

        <footer>
            <div class="footer-info">
                <p>ðŸ“§ subedisubedi7@gmail.com</p>
                <p>ðŸ“ž +977-9847877867</p>
            </div>
            <div class="visitor-counter">
                <span>Visitors</span>
                <span class="counter-number" id="visitor-count">0</span>
            </div>
        </footer>
    </div>

    <!-- EVENTS TAB -->
    <div id="events-tab">
        <div class="events-container">
            <button id="close-events-btn">âœ– Close Events</button>
            <div class="events-header">
                <div class="events-title">
                    <h2>ðŸ“œ Event Log</h2>
                </div>
                <div class="last-update">
                    Last updated: <span id="events-last-update">--:--</span>
                    <button id="update-events-btn" class="update-events-btn">ðŸ”„ Update Events</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>System</th>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="events-body">
                    <tr>
                        <td colspan="3" class="no-events">No events to display</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, get, set, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // ================= FIREBASE CONFIG ===================
        const firebaseConfig = {
            apiKey: "AIzaSyBa1Gb5uDd8-Rjue5VxTE7kOQ9O2n-2xbI",
            authDomain: "feeders-status-21646.firebaseapp.com",
            databaseURL: "https://feeders-status-21646-default-rtdb.firebaseio.com/",
            projectId: "feeders-status-21646",
            storageBucket: "feeders-status-21646.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================= GLOBAL VARIABLES ===================
        const systems = {
            "33kv-system": "132 kV System",
            "Feeder-1": "11 kV INCOMER", 
            "Feeder-2": "11 kV ASHNIYA-1",
            "Feeder-3": "11 kV RAMAWAPUR-2",
            "Feeder-4": "SPARE FEEDER-3"
        };
        
        const systemIds = Object.keys(systems);
        const CORRECT_PIN = "1234";
        let isAuthenticated = false;
        let notificationPermission = false;
        let notificationsEnabled = true;
        let lastReferenceTime = null;
        let blinkInterval = null;
        const originalTitle = "NEA Substation";
        const lastStatus = {};
        let initialLoadComplete = false;
        let lastEventsUpdate = null;
        let isUpdatingEvents = false;

        // ================= VISITOR COUNTER ===================
        async function updateVisitorCounter() {
            try {
                if (!sessionStorage.getItem('visited')) {
                    const visitorRef = ref(db, 'visitors/count');
                    await set(visitorRef, increment(1));
                    sessionStorage.setItem('visited', 'true');
                }
                
                const visitorRef = ref(db, 'visitors/count');
                onValue(visitorRef, (snapshot) => {
                    const count = snapshot.val() || 0;
                    document.getElementById('visitor-count').textContent = count;
                });
            } catch (error) {
                console.error('Error updating visitor counter:', error);
            }
        }

        // ================= BACKGROUND NOTIFICATION FUNCTIONS ===================
        function showBrowserNotification(title, message, tag = '') {
            if (!("Notification" in window) || !notificationsEnabled) return;
            
            if (Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iOCIgZmlsbD0iIzE2MjEzZSIvPgo8cGF0aCBkPSJNMzIgMTZDMzYuNDE4MyAxNiA0MCAxOS41ODE3IDQwIDI0VjM0QzQwIDM2LjIwMTUgNDEuMjQzOCAzOC4wNjA1IDQzLjE2MTQgMzguNzA0N3M0IDQyTDIwIDQyQzIwIDM4LjA2MDUgMjMuMjQzOCAzNi4yMDE1IDIzLjE2MTQgMzQuNzA0N0wyNCAzNFYyNEMyNCAxOS41ODE3IDI3LjU4MTcgMTYgMzIgMTZaIiBmaWxsPSIjZTk0NTYwIi8+CjxyZWN0IHg9IjI4IiB5PSI0NCIgd2lkdGg9IjgiIGhlaWdodD0iOCIgcng9IjQiIGZpbGw9IiNlOTQ1NjAiLz4KPC9zdmc+',
                    tag: tag || 'nea-notification',
                    requireInteraction: true,
                    silent: false
                });
                
                playNotificationSound();
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
                
                setTimeout(() => {
                    if (notification) notification.close();
                }, 10000);
            }
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio context not supported');
            }
        }

        function updateNotificationStatus() {
            const statusElement = document.getElementById('notification-status-text');
            if (Notification.permission === "granted" && notificationsEnabled) {
                statusElement.textContent = "Enabled";
                statusElement.className = "status-online";
            } else {
                statusElement.textContent = "Disabled";
                statusElement.className = "status-offline";
            }
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "default") {
                document.getElementById('notification-permission-prompt').style.display = 'block';
                updateNotificationStatus();
            } else if (Notification.permission === "granted") {
                notificationPermission = true;
                document.getElementById('notification-toggle').checked = true;
                updateNotificationStatus();
            }
        }

        function enableNotifications() {
            if (!("Notification" in window)) return;
            
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationPermission = true;
                    notificationsEnabled = true;
                    document.getElementById('notification-permission-prompt').style.display = 'none';
                    document.getElementById('notification-toggle').checked = true;
                    updateNotificationStatus();
                    showBrowserNotification("NEA Substation", "Background notifications enabled successfully!");
                } else {
                    notificationsEnabled = false;
                    document.getElementById('notification-toggle').checked = false;
                    updateNotificationStatus();
                }
            });
        }

        function toggleNotifications() {
            notificationsEnabled = document.getElementById('notification-toggle').checked;
            
            if (notificationsEnabled && Notification.permission !== "granted") {
                enableNotifications();
            } else if (notificationsEnabled) {
                showBrowserNotification("NEA Substation", "Background notifications enabled");
                updateNotificationStatus();
            } else {
                updateNotificationStatus();
            }
        }

        // ================= PAGE VISIBILITY API ===================
        function handleVisibilityChange() {
            if (document.hidden) {
                document.getElementById('background-status').textContent = "Monitoring";
            } else {
                document.getElementById('background-status').textContent = "Active";
                stopBlinkingTitle();
            }
        }

        // ================= HELPER FUNCTIONS ===================
        function formatTime(date) {
            return new Intl.DateTimeFormat('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }).format(date);
        }

        function formatTimestamp(timestamp) {
            // Convert ESP8266 timestamp (milliseconds) to readable time
            if (!timestamp) return '--:--';
            
            // If timestamp is in milliseconds (from ESP8266 millis())
            if (timestamp > 1000000000000) {
                // It's already a proper timestamp
                return formatTime(new Date(timestamp));
            } else {
                // It's from ESP8266 millis() - convert to actual time
                const currentTime = new Date();
                const eventTime = new Date(currentTime - (Date.now() - timestamp));
                return formatTime(eventTime);
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = formatTime(now);
            if (lastReferenceTime) document.getElementById('last-ref-time').textContent = formatTime(lastReferenceTime);
        }

        function startBlinkingTitle(alertText) {
            if (blinkInterval) return;
            let visible = true;
            blinkInterval = setInterval(() => {
                document.title = visible ? alertText : originalTitle;
                visible = !visible;
            }, 1000);
        }

        function stopBlinkingTitle() {
            if (blinkInterval) {
                clearInterval(blinkInterval);
                blinkInterval = null;
                document.title = originalTitle;
            }
        }

        function updateEventsLastUpdate() {
            lastEventsUpdate = new Date();
            document.getElementById('events-last-update').textContent = formatTime(lastEventsUpdate);
        }

        // ================= STATUS & EVENT LOG ===================
        async function updateStatus(systemId, value, isInitialLoad = false) {
            const box = document.getElementById(systemId);
            if (!box) return;

            const systemName = systems[systemId];
            let status = value === 1 ? (systemId === "33kv-system" ? "LIVE" : "ON") : (systemId === "33kv-system" ? "System_Fail" : "OFF/TRIP");
            box.innerText = status;
            lastReferenceTime = new Date();
            updateClock();

            if (status === "System_Fail" || status === "OFF/TRIP") {
                box.className = "status-box off blink-red";
                
                if (!isInitialLoad && lastStatus.hasOwnProperty(systemId) && lastStatus[systemId] !== status) {
                    showBrowserNotification(
                        "âš ï¸ CRITICAL ALERT - NEA Substation", 
                        `${systemName} status changed to: ${status}`,
                        `critical-${systemId}-${Date.now()}`
                    );
                    
                    if (!document.hidden) {
                        startBlinkingTitle(`âš ï¸ ${systemName} ${status}`);
                    }
                }
            } else {
                box.className = "status-box on";
                
                if (!isInitialLoad && lastStatus.hasOwnProperty(systemId) && lastStatus[systemId] !== status) {
                    showBrowserNotification(
                        "âœ… System Update - NEA Substation", 
                        `${systemName} status changed to: ${status}`,
                        `update-${systemId}-${Date.now()}`
                    );
                }
                
                if (!document.hidden) {
                    stopBlinkingTitle();
                }
            }

            // Save event log with proper system name
            if (!isInitialLoad && lastStatus.hasOwnProperty(systemId) && lastStatus[systemId] !== status) {
                console.log(`Status change detected for ${systemName}: ${lastStatus[systemId]} -> ${status}`);
                lastStatus[systemId] = status;
                
                const logRef = ref(db, 'logs/' + systemId);
                const nowFormatted = formatTime(new Date());
                
                // Save with display name instead of technical ID
                await push(logRef, { 
                    system: systemName,
                    time: nowFormatted, 
                    status: status, 
                    timestamp: Date.now(),
                    systemId: systemId
                });

                // Keep max 10 events per system
                get(logRef).then(snapshot => {
                    const logs = snapshot.val();
                    if (logs) {
                        const keys = Object.keys(logs);
                        if (keys.length > 10) {
                            const keysToRemove = keys.slice(0, keys.length - 10);
                            keysToRemove.forEach(k => remove(ref(db, `logs/${systemId}/${k}`)));
                        }
                    }
                });
            } else {
                if (!lastStatus.hasOwnProperty(systemId)) {
                    console.log(`Initial status for ${systemName}: ${status}`);
                    lastStatus[systemId] = status;
                }
            }
        }

        // ================= DASHBOARD INIT ===================
        function initDashboard() {
            setInterval(updateClock, 1000);
            updateClock();
            
            updateVisitorCounter();
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            let systemsInitialized = 0;

            systemIds.forEach(systemId => {
                const sysRef = ref(db, systemId);
                onValue(sysRef, snap => {
                    const isInitial = !initialLoadComplete || !lastStatus.hasOwnProperty(systemId);
                    updateStatus(systemId, snap.val(), isInitial);

                    systemsInitialized++;
                    if (systemsInitialized >= systemIds.length && !initialLoadComplete) {
                        initialLoadComplete = true;
                        console.log("Initial load complete. Now tracking actual changes.");
                    }
                });
            });
        }

        // ================= AUTHENTICATION ===================
        function authenticate() {
            const pin = document.getElementById('pin-input').value;
            if (pin === CORRECT_PIN) {
                isAuthenticated = true;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                requestNotificationPermission();
                initDashboard();
            } else {
                alert("Invalid PIN");
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').focus();
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('pin-input').value = '';
            stopBlinkingTitle();
        }

        function refreshPage() {
            window.location.reload();
        }

        // ================= EVENTS TAB FUNCTIONS ===================
        function openEventsTab() {
            const tab = document.getElementById('events-tab');
            tab.style.display = 'block';
            loadAllEvents();
            updateEventsLastUpdate();
        }

        function closeEventsTab() {
            const tab = document.getElementById('events-tab');
            tab.style.display = 'none';
        }

        async function updateEvents() {
            if (isUpdatingEvents) return;
            
            isUpdatingEvents = true;
            const updateBtn = document.getElementById('update-events-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'ðŸ”„ Updating...';
            
            try {
                await loadAllEvents();
                updateEventsLastUpdate();
                showBrowserNotification("NEA Substation", "Events updated successfully!");
            } catch (error) {
                console.error('Error updating events:', error);
            } finally {
                isUpdatingEvents = false;
                updateBtn.disabled = false;
                updateBtn.textContent = 'ðŸ”„ Update Events';
            }
        }

        function loadAllEvents() {
            return new Promise((resolve, reject) => {
                const tbody = document.getElementById('events-body');
                tbody.innerHTML = '<tr><td colspan="3" class="no-events">Loading events...</td></tr>';

                let allEvents = [];
                let systemsProcessed = 0;

                systemIds.forEach(systemId => {
                    const logRef = ref(db, 'logs/' + systemId);
                    get(logRef).then(snap => {
                        const logs = snap.val();
                        if (logs) {
                            Object.values(logs).forEach(log => {
                                allEvents.push({
                                    system: log.system || systems[systemId],
                                    time: log.time || formatTimestamp(log.timestamp),
                                    status: log.status,
                                    timestamp: log.timestamp || Date.now()
                                });
                            });
                        }

                        systemsProcessed++;

                        if (systemsProcessed === systemIds.length) {
                            // Sort by timestamp (newest first)
                            allEvents.sort((a, b) => b.timestamp - a.timestamp);

                            tbody.innerHTML = '';
                            if (allEvents.length === 0) {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td colspan="3" class="no-events">No events to display</td>`;
                                tbody.appendChild(row);
                            } else {
                                allEvents.forEach(event => {
                                    const row = document.createElement('tr');
                                    // Add color coding based on status
                                    let statusClass = '';
                                    if (event.status === 'System_Fail' || event.status === 'OFF/TRIP') {
                                        statusClass = 'class="off"';
                                    } else {
                                        statusClass = 'class="on"';
                                    }
                                    
                                    row.innerHTML = `<td>${event.system}</td><td>${event.time}</td><td ${statusClass}>${event.status}</td>`;
                                    tbody.appendChild(row);
                                });
                            }
                            resolve(allEvents);
                        }
                    }).catch(error => {
                        console.error('Error loading events for', systemId, error);
                        systemsProcessed++;
                        if (systemsProcessed === systemIds.length) {
                            reject(error);
                        }
                    });
                });
            });
        }

        // DOM Events
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', authenticate);
            document.getElementById('pin-input').addEventListener('keypress', e => {
                if (e.key === "Enter") authenticate();
            });
            
            document.getElementById('enable-notifications').addEventListener('click', enableNotifications);
            document.getElementById('notification-toggle').addEventListener('change', toggleNotifications);
            document.getElementById('refresh-btn').addEventListener('click', refreshPage);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('events-btn').addEventListener('click', openEventsTab);
            document.getElementById('close-events-btn').addEventListener('click', closeEventsTab);
            document.getElementById('update-events-btn').addEventListener('click', updateEvents);
            
            updateNotificationStatus();
        });

        window.openEventsTab = openEventsTab;
        window.closeEventsTab = closeEventsTab;
        window.refreshPage = refreshPage;
        window.logout = logout;
    </script>
</body>
</html>
