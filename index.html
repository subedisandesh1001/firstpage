<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEA Substation</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getDatabase, ref, onValue, push, get, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

// ================= FIREBASE CONFIG ===================
const firebaseConfig = {
  apiKey: "AIzaSyBa1Gb5uDd8-Rjue5VxTE7kOQ9O2n-2xbI",
  authDomain: "feeders-status-21646.firebaseapp.com",
  databaseURL: "https://feeders-status-21646-default-rtdb.firebaseio.com/",
  projectId: "feeders-status-21646",
  storageBucket: "feeders-status-21646.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ================= GLOBAL VARIABLES ===================
const feeders = ["Feeder-1","Feeder-2","Feeder-3","Feeder-4","Feeder-5","Feeder-6","Feeder-7"];
const lastStatus = {};
const firstLoad = {};
let isAuthenticated = false;
let visitorCount = 0;
let notificationPermission = false;
let blinkInterval = null;
const originalTitle = "NEA Substation";
const CORRECT_PIN = "1234"; // PIN for login

// ================= HELPER FUNCTIONS ===================
function formatTime(date) {
  return new Date(date).toLocaleString("en-GB");
}

function updateClock() {
  document.getElementById("current-time").textContent = formatTime(new Date());
}
setInterval(updateClock, 1000);
updateClock();

function showNotification(message, type="info") {
  const container = document.getElementById("notifications-container");
  const div = document.createElement("div");
  div.className = `notification ${type}`;
  div.innerHTML = `
    <span>${type==="alert"?"‚ö†Ô∏è":"‚ÑπÔ∏è"}</span>
    <span>${message}</span>
    <button onclick="this.parentElement.remove()">√ó</button>
  `;
  container.appendChild(div);
  setTimeout(()=>div.remove(), 5000);

  if (notificationPermission && (document.hidden || !document.hasFocus())) {
    const title = type==="alert" ? "‚ö†Ô∏è NEA Substation Alert" : "‚ÑπÔ∏è NEA Substation";
    new Notification(title,{body:message});
  }

  // Blink tab if alert
  if (type==="alert") startBlinkingTitle("‚ö†Ô∏è ALERT in Substation ‚ö°");
}

function requestNotificationPermission() {
  if (!("Notification" in window)) return;
  if (Notification.permission==="granted") {
    notificationPermission = true;
  } else if (Notification.permission!=="denied") {
    Notification.requestPermission().then(p=>{
      if (p==="granted") notificationPermission = true;
    });
  }
}

function startBlinkingTitle(alertText) {
  if (blinkInterval) return;
  let visible = true;
  blinkInterval = setInterval(()=>{
    document.title = visible ? alertText : originalTitle;
    visible = !visible;
  },1000);
}

function stopBlinkingTitle() {
  if (blinkInterval) {
    clearInterval(blinkInterval);
    blinkInterval=null;
    document.title = originalTitle;
  }
}

function updateVisitorCount() {
  const refVC = ref(db,"visitorCount");
  get(refVC).then(snap=>{
    let count = snap.val() || 0;
    count++;
    set(refVC,count).then(()=>{
      visitorCount = count;
      document.getElementById("visitor-count").textContent = `Visitors: ${count}`;
    });
  });
}

// ================= AUTH ===================
function authenticate() {
  const pin = document.getElementById("pin-input").value;
  if (pin===CORRECT_PIN) {
    isAuthenticated = true;
    document.getElementById("login-screen").style.display="none";
    document.getElementById("dashboard").style.display="block";
    updateVisitorCount();
    requestNotificationPermission();
    initDashboard();
    showNotification("Authentication successful!","info");
  } else {
    showNotification("Invalid PIN","alert");
    document.getElementById("pin-input").value="";
  }
}
window.authenticate = authenticate;
window.logout = function() {
  isAuthenticated = false;
  stopBlinkingTitle();
  document.getElementById("login-screen").style.display="flex";
  document.getElementById("dashboard").style.display="none";
  showNotification("You have been logged out.","info");
};
window.refreshPage = ()=>window.location.reload();

// ================= STATUS + LOG ===================
async function logEvent(system,status) {
  const now = Date.now();
  const logRef = ref(db,"logs/"+system);
  await push(logRef,{
    time: formatTime(now),
    status: status,
    timestamp: now
  });
}

function updateStatus(name,value) {
  const box = document.getElementById(name.replace(" ","-"));
  if (!box) return;
  let currentStatus = value===1
    ? (name==="System33KV"?"LIVE":"ON")
    : (name==="System33KV"?"System_Fail":"OFF/TRIP");

  box.innerText = currentStatus;
  box.className = currentStatus==="LIVE"||currentStatus==="ON"
    ? "status-box on"
    : "status-box off blink-red";

  if (firstLoad[name] && lastStatus[name]!==currentStatus) {
    logEvent(name,currentStatus);
    showNotification(`${name} changed to ${currentStatus}`,"alert");
  }

  lastStatus[name]=currentStatus;
  firstLoad[name]=true;

  // stop blinking if everything is normal again
  if (Object.values(lastStatus).every(st => st==="LIVE"||st==="ON")) {
    stopBlinkingTitle();
  }
}

function showLogs(system) {
  const logRef = ref(db,"logs/"+system);
  const tableBody = document.getElementById(system.replace(" ","-")+"-log");
  onValue(logRef,(snap)=>{
    tableBody.innerHTML="";
    const logs = snap.val();
    if (!logs) {
      tableBody.innerHTML="<tr><td colspan='2'>No events yet</td></tr>";
      return;
    }
    const arr = Object.values(logs).sort((a,b)=>b.timestamp-a.timestamp);
    arr.slice(0,5).forEach(l=>{
      const row=document.createElement("tr");
      row.innerHTML=`<td>${l.time}</td><td>${l.status}</td>`;
      tableBody.appendChild(row);
    });
  });
}

function initDashboard() {
  // System
  firstLoad["System33KV"]=false;
  const sysRef = ref(db,"System33KV");
  onValue(sysRef,(snap)=>updateStatus("System33KV",snap.val()));
  showLogs("System33KV");

  // Feeders
  feeders.forEach(fd=>{
    firstLoad[fd]=false;
    const fdRef = ref(db,"Feeders/"+fd);
    onValue(fdRef,(snap)=>updateStatus(fd,snap.val()));
    showLogs(fd);
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("pin-input").addEventListener("keypress",e=>{
    if (e.key==="Enter") authenticate();
  });
  document.getElementById("login-btn").addEventListener("click",authenticate);
});
</script>

<style>
body{font-family:Arial,sans-serif;background:#16213e;color:#fff;margin:0}
#login-screen{display:flex;align-items:center;justify-content:center;height:100vh}
.login-container{background:#222;padding:20px;border-radius:10px;text-align:center}
.pin-input{padding:10px;width:100%;margin-bottom:10px}
.login-btn{padding:10px;width:100%;background:#e94560;border:none;color:#fff;cursor:pointer}
#dashboard{display:none}
.header{text-align:center;padding:15px;background:rgba(0,0,0,0.3)}
.dashboard{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;padding:15px}
.card{background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;width:260px}
.status-box{padding:8px;font-weight:bold;border-radius:6px}
.on{background:green}
.off{background:red}
.blink-red{animation:blink 1s infinite}
@keyframes blink{50%{opacity:0.5}}
table{width:100%;font-size:0.8rem;margin-top:5px}
#notifications-container{position:fixed;top:10px;right:10px}
.notification{background:#333;color:#fff;padding:8px;margin-bottom:5px;border-left:4px solid #e94560;border-radius:4px}
.notification.alert{border-left-color:yellow}
footer{text-align:center;margin-top:20px;padding:10px;background:rgba(0,0,0,0.3)}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="login-screen">
  <div class="login-container">
    <h1>‚ö° NEA Substation</h1>
    <p>Enter PIN (1234)</p>
    <input type="password" id="pin-input" class="pin-input" maxlength="4">
    <button id="login-btn" class="login-btn">Login</button>
  </div>
</div>

<!-- Notifications -->
<div id="notifications-container"></div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="header">
    <h1>‚ö° NEA Substation Dashboard</h1>
    <p>Current Time: <span id="current-time">--:--</span></p>
    <button onclick="refreshPage()">üîÑ Refresh</button>
    <button onclick="logout()">üö™ Logout</button>
  </div>

  <div class="dashboard">
    <div class="card">
      <h2>System 33 kV</h2>
      <div id="System33KV" class="status-box">--</div>
      <table><tbody id="System33KV-log"><tr><td colspan="2">No events yet</td></tr></tbody></table>
    </div>
    <!-- Feeders -->
    <div class="card"><h2>Feeder-1</h2><div id="Feeder-1" class="status-box">--</div><table><tbody id="Feeder-1-log"></tbody></table></div>
    <div class="card"><h2>Feeder-2</h2><div id="Feeder-2" class="status-box">--</div><table><tbody id="Feeder-2-log"></tbody></table></div>
    <div class="card"><h2>Feeder-3</h2><div id="Feeder-3" class="status-box">--</div><table><tbody id="Feeder-3-log"></tbody></table></div>
    <div class="card"><h2>Feeder-4</h2><div id="Feeder-4" class="status-box">--</div><table><tbody id="Feeder-4-log"></tbody></table></div>
    <div class="card"><h2>Feeder-5</h2><div id="Feeder-5" class="status-box">--</div><table><tbody id="Feeder-5-log"></tbody></table></div>
    <div class="card"><h2>Feeder-6</h2><div id="Feeder-6" class="status-box">--</div><table><tbody id="Feeder-6-log"></tbody></table></div>
    <div class="card"><h2>Feeder-7</h2><div id="Feeder-7" class="status-box">--</div><table><tbody id="Feeder-7-log"></tbody></table></div>
  </div>

  <footer>
    <div id="visitor-count">Visitors: 0</div>
    <p>üìß subedisubedi7@gmail.com | üìû +977-9847877867</p>
  </footer>
</div>
</body>
</html>
