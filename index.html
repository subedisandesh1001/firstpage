<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEA Substation</title>
    <style>
        :root {
            --primary: #16213e;
            --secondary: #0f3460;
            --accent: #e94560;
            --success: #4CAF50;
            --danger: #f44336;
            --text: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.08);
            --header-bg: rgba(15, 52, 96, 0.7);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text);
            background: var(--primary);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Electronic Circuits Background */
        .circuit-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(79, 172, 254, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(15, 52, 96, 0.25) 0%, transparent 50%);
            background-color: var(--primary);
            overflow: hidden;
        }
        
        /* Circuit Board Base */
        .circuit-board {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(90deg, transparent 79px, rgba(255, 255, 255, 0.03) 81px, transparent 82px),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px;
            background-position: -1px -1px, -1px -1px;
            animation: gridMove 120s linear infinite;
            opacity: 0.6;
        }
        
        /* Circuit Paths */
        .circuit-path {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4fdcfe, transparent);
            border-radius: 1px;
            filter: blur(0.5px);
            opacity: 0.7;
        }
        
        .path-1 { top: 20%; left: 0; width: 100%; }
        .path-2 { top: 40%; left: 0; width: 100%; }
        .path-3 { top: 60%; left: 0; width: 100%; }
        .path-4 { top: 80%; left: 0; width: 100%; }
        
        /* Circuit Nodes */
        .circuit-node {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #4fdcfe;
            border-radius: 50%;
            box-shadow: 0 0 10px #4fdcfe;
            animation: nodePulse 3s ease-in-out infinite;
        }
        
        .node-1 { top: 20%; left: 10%; animation-delay: 0s; }
        .node-2 { top: 20%; left: 30%; animation-delay: 0.5s; }
        .node-3 { top: 20%; left: 50%; animation-delay: 1s; }
        .node-4 { top: 20%; left: 70%; animation-delay: 1.5s; }
        .node-5 { top: 20%; left: 90%; animation-delay: 2s; }
        
        .node-6 { top: 40%; left: 15%; animation-delay: 0.2s; }
        .node-7 { top: 40%; left: 35%; animation-delay: 0.7s; }
        .node-8 { top: 40%; left: 55%; animation-delay: 1.2s; }
        .node-9 { top: 40%; left: 75%; animation-delay: 1.7s; }
        .node-10 { top: 40%; left: 95%; animation-delay: 2.2s; }
        
        .node-11 { top: 60%; left: 5%; animation-delay: 0.4s; }
        .node-12 { top: 60%; left: 25%; animation-delay: 0.9s; }
        .node-13 { top: 60%; left: 45%; animation-delay: 1.4s; }
        .node-14 { top: 60%; left: 65%; animation-delay: 1.9s; }
        .node-15 { top: 60%; left: 85%; animation-delay: 2.4s; }
        
        .node-16 { top: 80%; left: 20%; animation-delay: 0.1s; }
        .node-17 { top: 80%; left: 40%; animation-delay: 0.6s; }
        .node-18 { top: 80%; left: 60%; animation-delay: 1.1s; }
        .node-19 { top: 80%; left: 80%; animation-delay: 1.6s; }
        
        /* Data Flow Animation */
        .data-flow {
            position: absolute;
            width: 12px;
            height: 4px;
            background: radial-gradient(circle, #e94560, #ff6b6b, transparent);
            border-radius: 2px;
            filter: blur(1px);
            opacity: 0.8;
            z-index: 1;
            animation: dataFlow 8s linear infinite;
        }
        
        .flow-1 { top: 20%; animation-delay: 0s; }
        .flow-2 { top: 40%; animation-delay: 1s; }
        .flow-3 { top: 60%; animation-delay: 2s; }
        .flow-4 { top: 80%; animation-delay: 3s; }
        .flow-5 { top: 20%; animation-delay: 4s; }
        .flow-6 { top: 40%; animation-delay: 5s; }
        .flow-7 { top: 60%; animation-delay: 6s; }
        .flow-8 { top: 80%; animation-delay: 7s; }
        
        @keyframes gridMove {
            0% {
                background-position: -1px -1px, -1px -1px;
            }
            100% {
                background-position: -1px -10000px, -1px -10000px;
            }
        }
        
        @keyframes nodePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
                box-shadow: 0 0 10px #4fdcfe;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
                box-shadow: 0 0 20px #4fdcfe, 0 0 30px #4fdcfe;
            }
        }
        
        @keyframes dataFlow {
            0% {
                left: 0%;
                opacity: 0.8;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                left: 100%;
                opacity: 0;
                transform: scale(0.8);
            }
        }
        
        /* Login Screen */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: relative;
            z-index: 10;
        }
        
        .login-container {
            background: rgba(15, 52, 96, 0.85);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .login-logo {
            height: 70px;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(79, 172, 254, 0.5));
        }
        
        .login-title {
            font-size: 1.8rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #e94560, #4fdcfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-subtitle {
            color: #aaa;
            margin-bottom: 25px;
            font-size: 0.9rem;
        }
        
        .pin-input {
            padding: 12px 15px;
            width: 100%;
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }
        
        .pin-input:focus {
            outline: none;
            border-color: #4fdcfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        
        .pin-input::placeholder {
            color: #aaa;
        }
        
        .login-btn {
            padding: 12px;
            width: 100%;
            background: linear-gradient(135deg, #e94560, #d1344e);
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #d1344e, #e94560);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .login-btn:hover::before {
            left: 100%;
        }
        
        /* Dashboard */
        #dashboard {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: var(--header-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-center {
            text-align: center;
            flex-grow: 1;
            margin: 0 20px;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
        }
        
        .logo-main {
            height: 60px;
            filter: drop-shadow(0 0 5px rgba(79, 172, 254, 0.5));
        }
        
        .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .main-title {
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(90deg, #e94560, #4fdcfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: #aaa;
            margin: 0;
        }
        
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 25px;
        }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            width: 280px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #e94560, #4fdcfe);
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .card h2 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #e0e0e0;
        }
        
        .status-box {
            padding: 15px;
            font-weight: bold;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .status-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .status-box:hover::before {
            opacity: 1;
        }
        
        .on {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .off {
            background: linear-gradient(135deg, var(--danger), #c62828);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }
        
        @keyframes blink-red-animation {
            0%, 100% {
                background: linear-gradient(135deg, var(--danger), #c62828);
                transform: scale(1);
            }
            50% {
                background: linear-gradient(135deg, #ff5252, #b71c1c);
                transform: scale(1.05);
            }
        }
        
        .blink-red {
            animation: blink-red-animation 1s infinite;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--header-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .footer-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .visitor-counter {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .counter-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }
        
        button {
            cursor: pointer;
            padding: 10px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 6px;
            background: var(--secondary);
            color: white;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        button:hover {
            background: #1a4a7a;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        .designer-credit {
            position: fixed;
            bottom: 5px;
            right: 10px;
            font-size: 0.8rem;
            color: #888;
            z-index: 100;
        }
        
        /* Events Tab */
        #events-tab {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            overflow: auto;
            color: white;
            z-index: 1000;
            padding: 20px;
        }
        
        #events-tab table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        #events-tab th, #events-tab td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: center;
        }
        
        #events-tab th {
            background: rgba(15, 52, 96, 0.7);
            font-weight: 600;
        }
        
        #close-events-btn {
            background: var(--accent);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #close-events-btn:hover {
            background: #d1344e;
        }
        
        .events-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .no-events {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .events-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .last-update {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .update-events-btn {
            background: var(--success);
            margin-left: 10px;
        }
        
        .update-events-btn:hover {
            background: #45a049;
        }
        
        .update-events-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .duration-cell {
            font-weight: bold;
            color: #4fdcfe;
        }
        
        /* Status cell colors covering entire text area */
        .status-cell-on {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(46, 125, 50, 0.3));
            color: #4CAF50;
            font-weight: bold;
            border-radius: 4px;
            padding: 8px 12px;
            margin: -4px;
            display: inline-block;
            min-width: 80px;
        }
        
        .status-cell-off {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(198, 40, 40, 0.3));
            color: #f44336;
            font-weight: bold;
            border-radius: 4px;
            padding: 8px 12px;
            margin: -4px;
            display: inline-block;
            min-width: 80px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-center {
                order: 1;
                margin: 10px 0;
            }
            
            .header-left, .header-right {
                order: 2;
                justify-content: center;
            }
            
            .main-title {
                font-size: 1.5rem;
            }
            
            .dashboard {
                padding: 15px;
            }
            
            .card {
                width: 100%;
                max-width: 350px;
            }
            
            footer {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-info, .visitor-counter {
                align-items: center;
            }
            
            #events-tab table {
                font-size: 0.8rem;
            }
            
            #events-tab th, #events-tab td {
                padding: 8px 4px;
            }
            
            .status-cell-on, .status-cell-off {
                padding: 6px 8px;
                min-width: 60px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Electronic Circuits Background -->
    <div class="circuit-background">
        <div class="circuit-board"></div>
        
        <!-- Circuit Paths -->
        <div class="circuit-path path-1"></div>
        <div class="circuit-path path-2"></div>
        <div class="circuit-path path-3"></div>
        <div class="circuit-path path-4"></div>
        
        <!-- Circuit Nodes -->
        <div class="circuit-node node-1"></div>
        <div class="circuit-node node-2"></div>
        <div class="circuit-node node-3"></div>
        <div class="circuit-node node-4"></div>
        <div class="circuit-node node-5"></div>
        <div class="circuit-node node-6"></div>
        <div class="circuit-node node-7"></div>
        <div class="circuit-node node-8"></div>
        <div class="circuit-node node-9"></div>
        <div class="circuit-node node-10"></div>
        <div class="circuit-node node-11"></div>
        <div class="circuit-node node-12"></div>
        <div class="circuit-node node-13"></div>
        <div class="circuit-node node-14"></div>
        <div class="circuit-node node-15"></div>
        <div class="circuit-node node-16"></div>
        <div class="circuit-node node-17"></div>
        <div class="circuit-node node-18"></div>
        <div class="circuit-node node-19"></div>
        
        <!-- Data Flow Animation -->
        <div class="data-flow flow-1"></div>
        <div class="data-flow flow-2"></div>
        <div class="data-flow flow-3"></div>
        <div class="data-flow flow-4"></div>
        <div class="data-flow flow-5"></div>
        <div class="data-flow flow-6"></div>
        <div class="data-flow flow-7"></div>
        <div class="data-flow flow-8"></div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-container">
            <img src="logo1.png" alt="Logo" class="login-logo">
            <h1 class="login-title">NEA Sunwal S/S</h1>
            <p class="login-subtitle">Enter PIN to access dashboard</p>
            <input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="Enter PIN">
            <button id="login-btn" class="login-btn">
                <span>🔐</span>
                <span>Login</span>
            </button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="header">
            <div class="header-left">
                <img src="logo.png" alt="logo" class="logo-main">
            </div>
            <div class="header-center">
                <div class="title-container">
                    <h1 class="main-title">132/33/11KV SUNWAL SUBSTATION</h1>
                    <p class="subtitle">Current Time: <span id="current-time">--:--</span> | Last Update: <span id="last-ref-time">--:--</span></p>
                </div>
            </div>
            <div class="header-right">
                <button id="refresh-btn">🔄 Refresh</button>
                <button id="logout-btn">🚪 Logout</button>
                <button id="events-btn">📜 Events</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>132 kV System</h2>
                <div id="33kv-system" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV INCOMER CB </h2>
                <div id="Feeder-1" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV ASHNIYA CB</h2>
                <div id="Feeder-2" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV RAMAWAPUR CB</h2>
                <div id="Feeder-3" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>SPARE FEEDER-3</h2>
                <div id="Feeder-4" class="status-box">--</div>
            </div>
        </div>

        <footer>
            <div class="footer-info">
                <p>📧 subedisubedi7@gmail.com</p>
                <p>📞 +977-9847877867</p>
                <p>⚠️ Testing Mode</p>
            </div>
            <div class="visitor-counter">
                <span>Visitors</span>
                <span class="counter-number" id="visitor-count">0</span>
            </div>
        </footer>
        
        <div class="designer-credit">
            Designed by <b>Subhash Subedi</b>
        </div>
    </div>

    <!-- EVENTS TAB -->
    <div id="events-tab">
        <div class="events-container">
            <button id="close-events-btn">✖ Close Events</button>
            <div class="events-header">
                <div class="events-title">
                    <h2>📜 Event Log</h2>
                </div>
                <div class="last-update">
                    Last updated: <span id="events-last-update">--:--</span>
                    <button id="update-events-btn" class="update-events-btn">🔄 Update Events</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>System</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="events-body">
                    <tr>
                        <td colspan="5" class="no-events">No events to display</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, get, set, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // ================= FIREBASE CONFIG ===================
        const firebaseConfig = {
            apiKey: "AIzaSyBa1Gb5uDd8-Rjue5VxTE7kOQ9O2n-2xbI",
            authDomain: "feeders-status-21646.firebaseapp.com",
            databaseURL: "https://feeders-status-21646-default-rtdb.firebaseio.com/",
            projectId: "feeders-status-21646",
            storageBucket: "feeders-status-21646.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================= GLOBAL VARIABLES ===================
        const systems = {
            "33kv-system": "132 kV System",
            "Feeder-1": "11 kV INCOMER", 
            "Feeder-2": "11 kV ASHNIYA-1",
            "Feeder-3": "11 kV RAMAWAPUR-2",
            "Feeder-4": "SPARE FEEDER-3"
        };
        
        const systemIds = Object.keys(systems);
        const CORRECT_PIN = "0000";
        let isAuthenticated = false;
        let lastReferenceTime = null;
        let blinkInterval = null;
        const originalTitle = "NEA Substation";
        const lastStatus = {};
        let initialLoadComplete = false;
        let lastEventsUpdate = null;
        let isUpdatingEvents = false;

        // ================= VISITOR COUNTER ===================
        async function updateVisitorCounter() {
            try {
                if (!sessionStorage.getItem('visited')) {
                    const visitorRef = ref(db, 'visitors/count');
                    await set(visitorRef, increment(1));
                    sessionStorage.setItem('visited', 'true');
                }
                
                const visitorRef = ref(db, 'visitors/count');
                onValue(visitorRef, (snapshot) => {
                    const count = snapshot.val() || 0;
                    document.getElementById('visitor-count').textContent = count;
                });
            } catch (error) {
                console.error('Error updating visitor counter:', error);
            }
        }

        // ================= HELPER FUNCTIONS ===================
        function formatTime(date) {
            return new Intl.DateTimeFormat('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }).format(date);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = formatTime(now);
            if (lastReferenceTime) document.getElementById('last-ref-time').textContent = formatTime(lastReferenceTime);
        }

        function startBlinkingTitle(alertText) {
            if (blinkInterval) return;
            let visible = true;
            blinkInterval = setInterval(() => {
                document.title = visible ? alertText : originalTitle;
                visible = !visible;
            }, 1000);
        }

        function stopBlinkingTitle() {
            if (blinkInterval) {
                clearInterval(blinkInterval);
                blinkInterval = null;
                document.title = originalTitle;
            }
        }

        function updateEventsLastUpdate() {
            lastEventsUpdate = new Date();
            document.getElementById('events-last-update').textContent = formatTime(lastEventsUpdate);
        }

        function calculateDuration(startTime, endTime) {
            if (!startTime || startTime === '--') return '--';
            
            const start = new Date(startTime);
            let end;
            
            if (!endTime || endTime === '--') {
                end = new Date(); // Current time for ongoing events
            } else {
                end = new Date(endTime);
            }
            
            const diffMs = end - start;
            
            if (diffMs < 0) return '--';
            
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // ================= STATUS & EVENT LOG ===================
        async function updateStatus(systemId, value, isInitialLoad = false) {
            const box = document.getElementById(systemId);
            if (!box) return;

            const systemName = systems[systemId];
            let status = value === 1 ? (systemId === "33kv-system" ? "LIVE" : "ON") : (systemId === "33kv-system" ? "System_Fail" : "OFF/TRIP");
            box.innerText = status;
            lastReferenceTime = new Date();
            updateClock();

            if (status === "System_Fail" || status === "OFF/TRIP") {
                box.className = "status-box off blink-red";
                
                if (!isInitialLoad && lastStatus.hasOwnProperty(systemId) && lastStatus[systemId] !== status) {
                    if (!document.hidden) {
                        startBlinkingTitle(`⚠️ ${systemName} ${status}`);
                    }
                }
            } else {
                box.className = "status-box on";
                
                if (!document.hidden) {
                    stopBlinkingTitle();
                }
            }

            // Only update status display, no event logging to Firebase
            if (!isInitialLoad && lastStatus.hasOwnProperty(systemId) && lastStatus[systemId] !== status) {
                console.log(`Status change detected for ${systemName}: ${lastStatus[systemId]} -> ${status}`);
                lastStatus[systemId] = status;
            } else {
                if (!lastStatus.hasOwnProperty(systemId)) {
                    console.log(`Initial status for ${systemName}: ${status}`);
                    lastStatus[systemId] = status;
                }
            }
        }

        // ================= DASHBOARD INIT ===================
        function initDashboard() {
            setInterval(updateClock, 1000);
            updateClock();
            
            updateVisitorCounter();
            
            let systemsInitialized = 0;

            systemIds.forEach(systemId => {
                const sysRef = ref(db, systemId);
                onValue(sysRef, snap => {
                    const isInitial = !initialLoadComplete || !lastStatus.hasOwnProperty(systemId);
                    updateStatus(systemId, snap.val(), isInitial);

                    systemsInitialized++;
                    if (systemsInitialized >= systemIds.length && !initialLoadComplete) {
                        initialLoadComplete = true;
                        console.log("Initial load complete. Now tracking actual changes.");
                    }
                });
            });
        }

        // ================= AUTHENTICATION ===================
        function authenticate() {
            const pin = document.getElementById('pin-input').value;
            if (pin === CORRECT_PIN) {
                isAuthenticated = true;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                initDashboard();
            } else {
                alert("Invalid PIN");
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').focus();
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('pin-input').value = '';
            stopBlinkingTitle();
        }

        function refreshPage() {
            window.location.reload();
        }

        // ================= EVENTS TAB FUNCTIONS ===================
        function openEventsTab() {
            const tab = document.getElementById('events-tab');
            tab.style.display = 'block';
            loadAllEvents();
            updateEventsLastUpdate();
        }

        function closeEventsTab() {
            const tab = document.getElementById('events-tab');
            tab.style.display = 'none';
        }

        async function updateEvents() {
            if (isUpdatingEvents) return;
            
            isUpdatingEvents = true;
            const updateBtn = document.getElementById('update-events-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = '🔄 Updating...';
            
            try {
                await loadAllEvents();
                updateEventsLastUpdate();
            } catch (error) {
                console.error('Error updating events:', error);
            } finally {
                isUpdatingEvents = false;
                updateBtn.disabled = false;
                updateBtn.textContent = '🔄 Update Events';
            }
        }

        function loadAllEvents() {
            return new Promise((resolve, reject) => {
                const tbody = document.getElementById('events-body');
                tbody.innerHTML = '<tr><td colspan="5" class="no-events">Loading events...</td></tr>';

                let allEvents = [];
                let systemsProcessed = 0;

                systemIds.forEach(systemId => {
                    const logRef = ref(db, 'logs/' + systemId);
                    get(logRef).then(snap => {
                        const logs = snap.val();
                        if (logs) {
                            Object.values(logs).forEach(log => {
                                allEvents.push({
                                    system: log.system || systems[systemId],
                                    time: log.time || '--:--',
                                    status: log.status,
                                    timestamp: log.timestamp || Date.now()
                                });
                            });
                        }

                        systemsProcessed++;

                        if (systemsProcessed === systemIds.length) {
                            // Sort by timestamp (newest first)
                            allEvents.sort((a, b) => b.timestamp - a.timestamp);

                            tbody.innerHTML = '';
                            if (allEvents.length === 0) {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td colspan="5" class="no-events">No events to display</td>`;
                                tbody.appendChild(row);
                            } else {
                                // Group events by system and create start/end time pairs
                                const systemEvents = {};
                                
                                allEvents.forEach(event => {
                                    if (!systemEvents[event.system]) {
                                        systemEvents[event.system] = [];
                                    }
                                    systemEvents[event.system].push(event);
                                });

                                let allPeriods = [];

                                // Process each system's events to create start/end pairs
                                Object.keys(systemEvents).forEach(systemName => {
                                    const events = systemEvents[systemName];
                                    events.sort((a, b) => a.timestamp - b.timestamp);
                                    
                                    let currentStart = null;
                                    let currentStatus = null;
                                    
                                    for (let i = 0; i < events.length; i++) {
                                        const event = events[i];
                                        
                                        if (currentStart === null) {
                                            // First event for this system
                                            currentStart = event;
                                            currentStatus = event.status;
                                        } else if (event.status !== currentStatus) {
                                            // Status changed, create a duration entry
                                            allPeriods.push({
                                                system: systemName,
                                                startTime: currentStart.time,
                                                endTime: event.time,
                                                status: currentStart.status,
                                                endTimestamp: event.timestamp
                                            });
                                            
                                            // Start new period
                                            currentStart = event;
                                            currentStatus = event.status;
                                        }
                                        
                                        // Handle last event (ongoing status)
                                        if (i === events.length - 1 && currentStart) {
                                            allPeriods.push({
                                                system: systemName,
                                                startTime: currentStart.time,
                                                endTime: '--',
                                                status: currentStart.status,
                                                endTimestamp: Date.now() // Current time for ongoing
                                            });
                                        }
                                    }
                                });

                                // Sort all periods by end timestamp (newest first)
                                allPeriods.sort((a, b) => b.endTimestamp - a.endTimestamp);

                                // Add rows to table in reverse chronological order
                                allPeriods.forEach(period => {
                                    const row = document.createElement('tr');
                                    const duration = calculateDuration(period.startTime, period.endTime);
                                    
                                    // Add status cell color class covering entire text area
                                    const statusClass = (period.status === 'System_Fail' || period.status === 'OFF/TRIP') ? 
                                        'status-cell-off' : 'status-cell-on';
                                    
                                    row.innerHTML = `
                                        <td>${period.system}</td>
                                        <td>${period.startTime}</td>
                                        <td>${period.endTime}</td>
                                        <td class="duration-cell">${duration}</td>
                                        <td><span class="${statusClass}">${period.status}</span></td>
                                    `;
                                    tbody.appendChild(row);
                                });
                            }
                            resolve(allEvents);
                        }
                    }).catch(error => {
                        console.error('Error loading events for', systemId, error);
                        systemsProcessed++;
                        if (systemsProcessed === systemIds.length) {
                            reject(error);
                        }
                    });
                });
            });
        }

        // DOM Events
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', authenticate);
            document.getElementById('pin-input').addEventListener('keypress', e => {
                if (e.key === "Enter") authenticate();
            });
            
            document.getElementById('refresh-btn').addEventListener('click', refreshPage);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('events-btn').addEventListener('click', openEventsTab);
            document.getElementById('close-events-btn').addEventListener('click', closeEventsTab);
            document.getElementById('update-events-btn').addEventListener('click', updateEvents);
        });

        window.openEventsTab = openEventsTab;
        window.closeEventsTab = closeEventsTab;
        window.refreshPage = refreshPage;
        window.logout = logout;
    </script>
</body>
</html>
