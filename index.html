<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEA Substation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            background: #16213e;
        }
        
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        .login-container {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .pin-input {
            padding: 10px;
            width: 100%;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            background: #333;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 5px;
        }
        
        .pin-input::placeholder {
            color: #aaa;
        }
        
        .login-btn {
            padding: 10px;
            width: 100%;
            background: #e94560;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #d1344e;
        }
        
        #dashboard {
            display: none;
        }
        
        .header {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #333;
        }
        
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 15px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            width: 260px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .status-box {
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            text-align: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .on {
            background: green;
        }
        
        .off {
            background: red;
        }
        
        @keyframes blink-red-animation {
            0%, 100% {
                background-color: red;
                color: white;
                transform: scale(1);
            }
            50% {
                background-color: darkred;
                color: white;
                transform: scale(1.05);
            }
        }
        
        .blink-red {
            animation: blink-red-animation 1s infinite;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .visitor-counter {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
        }
        
        .counter-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e94560;
        }
        
        button {
            cursor: pointer;
            padding: 8px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            background: #0f3460;
            color: white;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1a4a7a;
        }
        
        .notification-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .toggle-label {
            margin-left: 8px;
            font-size: 0.9rem;
        }
        
        /* Events Tab */
        #events-tab {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            overflow: auto;
            color: white;
            z-index: 1000;
            padding: 20px;
        }
        
        #events-tab table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        #events-tab th, #events-tab td {
            border: 1px solid #fff;
            padding: 10px;
            text-align: center;
        }
        
        #events-tab th {
            background: #444;
        }
        
        #close-events-btn {
            background: #e94560;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        #close-events-btn:hover {
            background: #d1344e;
        }
        
        .events-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }
        
        .no-events {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        
        /* Notification styles */
        .notification-permission {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .notification-permission button {
            background: #e94560;
            margin-left: 10px;
        }
        
        .notification-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .status-online {
            color: #4CAF50;
        }
        
        .status-offline {
            color: #e94560;
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-container">
            <h1>âš¡ NEA Substation</h1>
            <p>Enter PIN (1234)</p>
            <input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="Enter PIN">
            <button id="login-btn" class="login-btn">Login</button>
            <div class="notification-permission" id="notification-permission-prompt">
                <p>Enable browser notifications for status alerts?</p>
                <button id="enable-notifications">Enable</button>
            </div>
            <div class="notification-status" id="notification-status">
                Notifications: <span id="notification-status-text" class="status-offline">Disabled</span>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="header">
            <h1>âš¡ NEA Substation Dashboard</h1>
            <p>Current Time: <span id="current-time">--:--</span> | Last Update: <span id="last-ref-time">--:--</span></p>
            <button id="refresh-btn">ðŸ”„ Refresh</button>
            <button id="logout-btn">ðŸšª Logout</button>
            <button id="events-btn">ðŸ“œ Events</button>
            <div class="notification-toggle">
                <input type="checkbox" id="notification-toggle" checked>
                <label for="notification-toggle" class="toggle-label">Enable Notifications</label>
            </div>
            <div class="notification-status">
                Background Monitoring: <span id="background-status" class="status-online">Active</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>132 kV System</h2>
                <div id="33kv-system" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>33 kV System</h2>
                <div id="Feeder-1" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV Feeder-2</h2>
                <div id="Feeder-2" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>11 kV Feeder-3</h2>
                <div id="Feeder-3" class="status-box">--</div>
            </div>
            <div class="card">
                <h2>Feeder-4</h2>
                <div id="Feeder-4" class="status-box">--</div>
            </div>
        </div>

        <footer>
            <div class="footer-info">
                <p>ðŸ“§ subedisubedi7@gmail.com</p>
                <p>ðŸ“ž +977-9847877867</p>
            </div>
            <div class="visitor-counter">
                <span>Visitors</span>
                <span class="counter-number" id="visitor-count">0</span>
            </div>
        </footer>
    </div>

    <!-- EVENTS TAB -->
    <div id="events-tab">
        <div class="events-container">
            <button id="close-events-btn">âœ– Close Events</button>
            <h2>Event Log</h2>
            <table>
                <thead>
                    <tr>
                        <th>System</th>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="events-body">
                    <tr>
                        <td colspan="3" class="no-events">No events to display</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, get, set, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // ================= FIREBASE CONFIG ===================
        const firebaseConfig = {
            apiKey: "AIzaSyBa1Gb5uDd8-Rjue5VxTE7kOQ9O2n-2xbI",
            authDomain: "feeders-status-21646.firebaseapp.com",
            databaseURL: "https://feeders-status-21646-default-rtdb.firebaseio.com/",
            projectId: "feeders-status-21646",
            storageBucket: "feeders-status-21646.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================= GLOBAL VARIABLES ===================
        // Reduced to only 4 feeders
        const systems = ["33kv-system", "Feeder-1", "Feeder-2", "Feeder-3", "Feeder-4"];
        const CORRECT_PIN = "1234";
        let isAuthenticated = false;
        let notificationPermission = false;
        let notificationsEnabled = true; // Default to enabled
        let lastReferenceTime = null;
        let blinkInterval = null;
        const originalTitle = "NEA Substation";
        const lastStatus = {}; // Tracks last known status to prevent logging on refresh
        let initialLoadComplete = false; // Flag to track initial data loading
        let serviceWorkerRegistration = null;

        // ================= VISITOR COUNTER ===================
        async function updateVisitorCounter() {
            try {
                // Check if this is a new visitor (using sessionStorage)
                if (!sessionStorage.getItem('visited')) {
                    const visitorRef = ref(db, 'visitors/count');
                    
                    // Use transaction to safely increment the counter
                    await set(visitorRef, increment(1));
                    
                    // Mark this session as visited
                    sessionStorage.setItem('visited', 'true');
                }
                
                // Always update the display with the current count
                const visitorRef = ref(db, 'visitors/count');
                onValue(visitorRef, (snapshot) => {
                    const count = snapshot.val() || 0;
                    document.getElementById('visitor-count').textContent = count;
                });
            } catch (error) {
                console.error('Error updating visitor counter:', error);
            }
        }

        // ================= BACKGROUND NOTIFICATION FUNCTIONS ===================
        function showBrowserNotification(title, message, tag = '') {
            if (!("Notification" in window) || !notificationsEnabled) return;
            
            if (Notification.permission === "granted") {
                // Create notification with tag to avoid duplicates
                const notification = new Notification(title, {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iOCIgZmlsbD0iIzE2MjEzZSIvPgo8cGF0aCBkPSJNMzIgMTZDMzYuNDE4MyAxNiA0MCAxOS41ODE3IDQwIDI0VjM0QzQwIDM2LjIwMTUgNDEuMjQzOCAzOC4wNjA1IDQzLjE2MTQgMzguNzA0N0w0NCA0MkgyMEM0MCAzOC4wNjA1IDIzLjI0MzggMzYuMjAxNSAyMy4xNjE0IDM0LjcwNDdMMjQgMzRWMjRDMjQgMTkuNTgxNyAyNy41ODE3IDE2IDMyIDE2WiIgZmlsbD0iI2U5NDU2MCIvPgo8Y2lyY2xlIGN4PSIzMiIgY3k9IjQ4IiByPSI0IiBmaWxsPSIjZTk0NTYwIi8+Cjwvc3ZnPgo=',
                    tag: tag || 'nea-notification',
                    requireInteraction: true, // Keep notification visible until user interacts
                    silent: false // Enable sound if supported
                });
                
                // Play notification sound if available
                playNotificationSound();
                
                // Focus on the tab when notification is clicked
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
                
                // Auto-close notification after 10 seconds (longer for background)
                setTimeout(() => {
                    if (notification) notification.close();
                }, 10000);
            }
        }

        function playNotificationSound() {
            // Create a simple notification sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio context not supported');
            }
        }

        function updateNotificationStatus() {
            const statusElement = document.getElementById('notification-status-text');
            if (Notification.permission === "granted" && notificationsEnabled) {
                statusElement.textContent = "Enabled";
                statusElement.className = "status-online";
            } else {
                statusElement.textContent = "Disabled";
                statusElement.className = "status-offline";
            }
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "default") {
                // Show permission prompt
                document.getElementById('notification-permission-prompt').style.display = 'block';
                updateNotificationStatus();
            } else if (Notification.permission === "granted") {
                notificationPermission = true;
                document.getElementById('notification-toggle').checked = true;
                updateNotificationStatus();
            }
        }

        function enableNotifications() {
            if (!("Notification" in window)) return;
            
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationPermission = true;
                    notificationsEnabled = true;
                    document.getElementById('notification-permission-prompt').style.display = 'none';
                    document.getElementById('notification-toggle').checked = true;
                    updateNotificationStatus();
                    showBrowserNotification("NEA Substation", "Background notifications enabled successfully!");
                } else {
                    notificationsEnabled = false;
                    document.getElementById('notification-toggle').checked = false;
                    updateNotificationStatus();
                }
            });
        }

        function toggleNotifications() {
            notificationsEnabled = document.getElementById('notification-toggle').checked;
            
            if (notificationsEnabled && Notification.permission !== "granted") {
                enableNotifications();
            } else if (notificationsEnabled) {
                showBrowserNotification("NEA Substation", "Background notifications enabled");
                updateNotificationStatus();
            } else {
                updateNotificationStatus();
            }
        }

        // ================= PAGE VISIBILITY API ===================
        function handleVisibilityChange() {
            if (document.hidden) {
                // Page is in background - ensure notifications will work
                console.log("Page is in background - notifications active");
                document.getElementById('background-status').textContent = "Monitoring";
            } else {
                // Page is visible
                console.log("Page is visible");
                document.getElementById('background-status').textContent = "Active";
                stopBlinkingTitle(); // Stop blinking when user returns to page
            }
        }

        // ================= HELPER FUNCTIONS ===================
        function formatTime(date) {
            return new Intl.DateTimeFormat('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }).format(date);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = formatTime(now);
            if (lastReferenceTime) document.getElementById('last-ref-time').textContent = formatTime(lastReferenceTime);
        }

        // Tab title blinking
        function startBlinkingTitle(alertText) {
            if (blinkInterval) return;
            let visible = true;
            blinkInterval = setInterval(() => {
                document.title = visible ? alertText : originalTitle;
                visible = !visible;
            }, 1000);
        }

        function stopBlinkingTitle() {
            if (blinkInterval) {
                clearInterval(blinkInterval);
                blinkInterval = null;
                document.title = originalTitle;
            }
        }

        // ================= STATUS & EVENT LOG ===================
        async function updateStatus(name, value, isInitialLoad = false) {
            const box = document.getElementById(name);
            if (!box) return;

            let status = value === 1 ? (name === "33kv-system" ? "LIVE" : "ON") : (name === "33kv-system" ? "System_Fail" : "OFF/TRIP");
            box.innerText = status;
            lastReferenceTime = new Date();
            updateClock();

            if (status === "System_Fail" || status === "OFF/TRIP") {
                box.className = "status-box off blink-red";
                
                // Show browser notification for status changes (even in background)
                if (!isInitialLoad && lastStatus.hasOwnProperty(name) && lastStatus[name] !== status) {
                    showBrowserNotification(
                        "âš ï¸ CRITICAL ALERT - NEA Substation", 
                        `${name} status changed to: ${status}`,
                        `critical-${name}-${Date.now()}`
                    );
                    
                    // Start blinking title if page is visible
                    if (!document.hidden) {
                        startBlinkingTitle(`âš ï¸ ${name} ${status}`);
                    }
                }
            } else {
                box.className = "status-box on";
                
                // Show browser notification for status changes (ON/LIVE)
                if (!isInitialLoad && lastStatus.hasOwnProperty(name) && lastStatus[name] !== status) {
                    showBrowserNotification(
                        "âœ… System Update - NEA Substation", 
                        `${name} status changed to: ${status}`,
                        `update-${name}-${Date.now()}`
                    );
                }
                
                if (!document.hidden) {
                    stopBlinkingTitle();
                }
            }

            // Only log if actual change (prevent logging on page load)
            if (!isInitialLoad && lastStatus.hasOwnProperty(name) && lastStatus[name] !== status) {
                console.log(`Status change detected for ${name}: ${lastStatus[name]} -> ${status}`);
                lastStatus[name] = status;
                const logRef = ref(db, 'logs/' + name);
                const nowFormatted = formatTime(new Date());
                await push(logRef, { time: nowFormatted, status: status, timestamp: Date.now() });

                // Keep max 10 events per system
                get(logRef).then(snapshot => {
                    const logs = snapshot.val();
                    if (logs) {
                        const keys = Object.keys(logs);
                        if (keys.length > 10) {
                            const keysToRemove = keys.slice(0, keys.length - 10);
                            keysToRemove.forEach(k => remove(ref(db, `logs/${name}/${k}`)));
                        }
                    }
                });
            } else {
                // Initialize lastStatus on first load without logging
                if (!lastStatus.hasOwnProperty(name)) {
                    console.log(`Initial status for ${name}: ${status}`);
                    lastStatus[name] = status;
                }
            }
        }

        // ================= DASHBOARD INIT ===================
        function initDashboard() {
            setInterval(updateClock, 1000);
            updateClock();
            
            // Initialize visitor counter
            updateVisitorCounter();

            // Set up page visibility detection
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Track how many systems have been initialized
            let systemsInitialized = 0;

            systems.forEach(sys => {
                const sysRef = ref(db, sys);
                onValue(sysRef, snap => {
                    // First time we get data for each system, mark it as initial load
                    const isInitial = !initialLoadComplete || !lastStatus.hasOwnProperty(sys);
                    updateStatus(sys, snap.val(), isInitial);

                    systemsInitialized++;
                    // When all systems have been initialized at least once, mark initial load as complete
                    if (systemsInitialized >= systems.length && !initialLoadComplete) {
                        initialLoadComplete = true;
                        console.log("Initial load complete. Now tracking actual changes.");
                    }
                });
            });
        }

        // ================= AUTHENTICATION ===================
        function authenticate() {
            const pin = document.getElementById('pin-input').value;
            if (pin === CORRECT_PIN) {
                isAuthenticated = true;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                requestNotificationPermission();
                initDashboard();
            } else {
                alert("Invalid PIN");
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').focus();
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('pin-input').value = '';
            stopBlinkingTitle();
        }

        function refreshPage() {
            window.location.reload();
        }

        // ================= EVENTS TAB ===================
        function openEventsTab() {
            const tab = document.getElementById('events-tab');
            tab.style.display = 'block';
            loadAllEvents();
        }

        function closeEventsTab() {
            const tab = document.getElementById('events-tab');
            tab.style.display = 'none';
        }

        function loadAllEvents() {
            const tbody = document.getElementById('events-body');
            tbody.innerHTML = '';

            // Collect all events from all systems
            let allEvents = [];
            let systemsProcessed = 0;

            systems.forEach(sys => {
                const logRef = ref(db, 'logs/' + sys);
                get(logRef).then(snap => {
                    const logs = snap.val();
                    if (logs) {
                        Object.values(logs).forEach(log => {
                            allEvents.push({
                                system: sys,
                                time: log.time,
                                status: log.status,
                                timestamp: log.timestamp
                            });
                        });
                    }

                    systemsProcessed++;

                    // When all systems have been processed, sort and display events
                    if (systemsProcessed === systems.length) {
                        // Sort by timestamp (newest first)
                        allEvents.sort((a, b) => b.timestamp - a.timestamp);

                        // Clear and populate table
                        tbody.innerHTML = '';
                        if (allEvents.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="3" class="no-events">No events to display</td>`;
                            tbody.appendChild(row);
                        } else {
                            allEvents.forEach(event => {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td>${event.system}</td><td>${event.time}</td><td>${event.status}</td>`;
                                tbody.appendChild(row);
                            });
                        }
                    }
                });
            });
        }

        // DOM Events
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', authenticate);
            document.getElementById('pin-input').addEventListener('keypress', e => {
                if (e.key === "Enter") authenticate();
            });
            
            // Notification permission button
            document.getElementById('enable-notifications').addEventListener('click', enableNotifications);
            
            // Notification toggle
            document.getElementById('notification-toggle').addEventListener('change', toggleNotifications);
            
            // Fixed event listeners for dashboard buttons
            document.getElementById('refresh-btn').addEventListener('click', refreshPage);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('events-btn').addEventListener('click', openEventsTab);
            document.getElementById('close-events-btn').addEventListener('click', closeEventsTab);
            
            // Initialize notification status
            updateNotificationStatus();
        });

        // Make functions globally available for HTML onclick handlers
        window.openEventsTab = openEventsTab;
        window.closeEventsTab = closeEventsTab;
        window.refreshPage = refreshPage;
        window.logout = logout;
    </script>
</body>
</html>
